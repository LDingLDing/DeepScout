# Staff 后台管理系统设计文档

## 一、系统概述

### 1.1 背景与目标

InfoRadar（信息雷达）系统需要一个专门的后台管理界面，供内部工作人员（Staff）管理系统核心资源，包括账号、信息源、采集任务和执行日志。本文档详细描述该 Staff 后台管理系统的设计方案。

### 1.2 核心功能

1. **账号管理**：Staff 账号的创建、登录、权限控制和密码管理
2. **任务日志管理**：查看和管理数据采集任务的执行日志

### 1.3 用户角色

| 角色 | 描述 | 权限范围 |
|------|------|----------|
| 管理员(ADMIN) | 系统最高权限用户 | 所有功能，包括 Staff 账号管理 |
| 运营管理员(MANAGER) | 负责日常运营的管理员 | 任务日志管理，部分账号管理权限 |
| 只读用户(VIEWER) | 仅有查看权限的用户 | 只能查看各模块数据，无修改权限 |

## 二、系统架构

### 2.1 技术栈

- **前端**：React + Next.js + Ant Design
- **后端**：NestJS + TypeScript
- **数据库**：PostgreSQL
- **认证**：JWT (JSON Web Token)

### 2.2 系统模块

```
Staff后台
├── 账号管理模块
│   ├── 登录/注销
│   ├── 账号列表
│   ├── 账号创建
│   ├── 账号编辑
│   └── 权限管理
└── 日志管理模块
    ├── 日志列表
    ├── 日志详情
    └── 日志筛选
```

### 2.3 项目目录结构

```
DeepScout/
├── staff/              # 后台管理系统
│   ├── frontend/       # Next.js前端应用
│   │   ├── src/        # 源代码
│   │   │   ├── api/        # API服务
│   │   │   ├── components/ # UI组件
│   │   │   ├── contexts/   # 上下文
│   │   │   ├── pages/      # 页面路由
│   │   │   ├── utils/      # 工具函数
│   │   │   └── styles/     # 样式文件
│   │   └── public/         # 静态资源
│   │
│   └── backend/        # NestJS后端服务
│       ├── src/        # 源代码
│       │   ├── modules/    # 业务模块
│       │   │   ├── staff/      # 账号管理模块
│       │   │   └── task-logs/  # 任务日志模块
│       │   ├── guards/     # 守卫
│       │   ├── decorators/ # 装饰器
│       │   ├── services/   # 服务
│       │   └── utils/      # 工具函数
│       └── test/           # 测试
```

## 三、数据库设计

### 3.1 Staff 账号表设计

`staff` 表用于管理后台账号：

| 字段名 | 类型 | 必填 | 默认值 | 描述 | 索引 |
|--------|------|------|--------|------|------|
| `id` | INT | 是 | 自增 | 员工唯一ID | 主键 |
| `username` | VARCHAR(50) | 是 | - | 登录用户名 | 唯一索引 |
| `password` | VARCHAR(100) | 是 | - | 加密后的密码 | - |
| `email` | VARCHAR(100) | 否 | NULL | 电子邮箱 | - |
| `role` | ENUM('admin','manager','viewer') | 是 | 'viewer' | 角色类型 | - |
| `isActive` | BOOLEAN | 否 | true | 账号状态 | - |
| `createdAt` | TIMESTAMP | 是 | CURRENT_TIMESTAMP | 创建时间 | - |
| `updatedAt` | TIMESTAMP | 是 | CURRENT_TIMESTAMP | 更新时间 | - |

### 3.2 任务日志表设计

`task_log` 表用于记录任务执行日志：

| 字段名 | 类型 | 必填 | 默认值 | 描述 | 索引 |
|--------|------|------|--------|------|------|
| `id` | INT | 是 | 自增 | 日志唯一ID | 主键 |
| `taskId` | INT | 是 | - | 关联的任务ID | - |
| `taskName` | VARCHAR(100) | 是 | - | 任务名称 | - |
| `status` | ENUM('success','failed','running') | 是 | 'running' | 任务状态 | - |
| `message` | TEXT | 否 | NULL | 日志消息 | - |
| `metadata` | JSONB | 否 | NULL | 元数据 | - |
| `createdAt` | TIMESTAMP | 是 | CURRENT_TIMESTAMP | 创建时间 | - |

## 四、功能模块详细设计

### 4.1 账号管理模块

#### 4.1.1 登录界面

- **功能**：用户名密码登录，记住登录状态选项
- **安全措施**：
  - 密码加盐哈希存储（使用bcrypt）
  - JWT认证

#### 4.1.2 账号列表

- **展示内容**：
  - 用户名、角色、状态、邮箱、创建时间、更新时间
  - 分页展示
  - 支持按用户名搜索
- **操作**：
  - 新建账号（仅管理员）
  - 编辑账号（仅管理员）
  - 禁用/启用账号（仅管理员）
  - 重置密码（仅管理员）

#### 4.1.3 账号创建/编辑

- **表单字段**：
  - 用户名（创建后不可修改）
  - 密码（创建时必填，编辑时可选）
  - 邮箱（可选）
  - 角色选择
  - 状态选择

### 4.2 日志管理模块

#### 4.2.1 日志列表

- **展示内容**：
  - 日志ID、任务ID、任务名称、状态、创建时间
  - 分页展示
  - 支持按状态、任务名称筛选
- **操作**：
  - 查看日志详情

#### 4.2.2 日志详情

- **展示内容**：
  - 日志基本信息
  - 详细消息
  - 元数据（JSON格式）

## 五、认证与权限控制

### 5.1 认证机制

- 使用JWT（JSON Web Token）进行认证
- 令牌包含用户ID、用户名和角色信息
- 令牌默认有效期为24小时

### 5.2 权限控制

- 基于角色的访问控制（RBAC）
- 使用守卫（Guard）和装饰器（Decorator）实现
- 权限检查在控制器层进行

## 六、前端实现

### 6.1 认证上下文

- 使用React Context API管理认证状态
- 提供登录、注销和获取当前用户信息的功能
- 在本地存储中保存令牌和用户信息

### 6.2 API服务

- 使用Axios进行HTTP请求
- 配置拦截器自动添加认证令牌
- 处理认证失败的情况

### 6.3 页面路由

- 使用Next.js的页面路由系统
- 实现路由守卫，保护需要认证的页面
- 根据用户角色动态显示菜单项
